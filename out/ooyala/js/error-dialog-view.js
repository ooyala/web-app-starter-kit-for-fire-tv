/* Error Dialog View
 *
 * Handles error dialog for ANY view.
 *
 */

(function (exports) {
    "use strict";

    /**
     * @class ErrorDialogView
     * @description The error dialog view object handles everything about the error dialog
     */
    function ErrorDialogView() {
        Events.call(this, ['exit', 'responseSelected']);

        this.errorObj = null;
        this.buttonView = null;
        this.$el = null;
        
        /**
         * renders the error dialog to show the user, can have up to two buttons with callbacks
         * @param {object} container object to show the error dialog
         * @param {object} the error object generated by the error handler, contains the buttons array for the dialog
         */
        this.render = function ($container, errorObj) {
            this.errorObj = errorObj;
            var html = utils.buildTemplate($("#error-dialog-template"), errorObj);
            $container.append(html);
            this.$el = $container.children().last();

            // set up the button view
            var buttonView = this.buttonView = new ButtonView();

            //Create a buttons array for the buttons you want to add
            var buttonArr = [];
            for (var i = 0; i < errorObj.buttons.length; i++) {
                buttonArr.push({
                    id: errorObj.buttons[i].id,
                    buttonValue: errorObj.buttons[i].text,
                });
            }

            // render the button view and select the first button
            buttonView.render(this.$el.find(".error-buttons-container"), buttonArr, this.handleButtonCallback);
            this.buttonView.updateCurrentSelectedIndex(0);

            // reselect the same button on the exit event, basically throw away the exit event in this dialog
            buttonView.on("exit", function() {
                this.buttonView.updateCurrentSelectedIndex(this.buttonView.selectedButtonIndex);
            }.bind(this));
        }

        /**
         * handles the button click callback and passes it to the correct errorObj button callback
         * @param {object} the button which was pressed by the user
         */
        this.handleButtonCallback = function(button) {
            var clickedButton = $(button).attr('id');
            // find the matching error button from the errorObj to call the callback
            for (var i = 0; i < this.errorObj.buttons.length; i++) {
                if (this.errorObj.buttons[i].id === clickedButton) {
                    this.errorObj.buttons[i].callback(this.errorObj.buttons[i]);
                    return;
                }
            }
        }.bind(this);

        /**
         * Handle key events
         * @param {event} the keydown event
         */
        this.handleControls = function (e) {
            this.buttonView.handleControls(e);
        }.bind(this);

        /**
         * Remove the error dialog from the app
         */
        this.remove = function() {
            this.$el.remove();
        }
    }

    exports.ErrorDialogView = ErrorDialogView;
}(window));
